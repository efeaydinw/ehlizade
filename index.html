<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ehlizade Muhasebe ‚Äì Pro</title>
  <meta name="theme-color" content="#225c0a" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: {
      colors:{ primary:'#225c0a', accent:'#e17703', dark:'#0f140f', soft:'#161d16', border:'#233e1a' },
      boxShadow:{ card:'0 12px 30px rgba(0,0,0,.25)' }
    } } }
  </script>
  <style>
    body{background:#0f140f;color:#eef0ee;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .card{background:#161d16;border:1px solid #233e1a;border-radius:16px}
    .chip{border:1px solid #225c0a;border-radius:9999px;padding:10px 16px;cursor:pointer;font-weight:700}
    .chip.active{background:#e17703;color:#000;border-color:#e17703}
    .btn{background:#225c0a;border-radius:12px;padding:12px 18px;font-weight:800}
    .btn:hover{filter:brightness(1.08)}
    .btn-sec{background:#1b221b}
    .inp{background:#121812;border:1px solid #225c0a;border-radius:12px;padding:12px 14px;width:100%}
    .tbl th{background:#1b221b}
    .badge{border:1px solid #225c0a;background:#1a2418;border-radius:9999px;padding:4px 10px;font-size:12px}
    .toast{position:fixed;right:16px;bottom:16px;display:none}
    .toast.show{display:block;animation:fadein .2s}
    @keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .iconbtn{display:inline-flex;align-items:center;gap:8px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.show{display:flex}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <!-- Topbar -->
  <header class="border-b border-border/60 bg-soft/60 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-primary grid place-items-center font-black">E</div>
      <div class="text-lg font-black tracking-wide text-accent">Ehlizade Muhasebe</div>
      <div class="ml-auto flex items-center gap-2 text-sm">
        <span id="roleBadge" class="badge hidden"></span>
        <button id="adminBtn" class="btn btn-sec hidden">Y√∂netim</button>
        <button id="logoutBtn" class="btn btn-sec hidden">√áƒ±kƒ±≈ü</button>
      </div>
    </div>
  </header>

  <!-- Toast -->
  <div id="toast" class="toast"><div id="toastBox" class="card p-3 text-sm"></div></div>

  <!-- AUTH -->
  <section id="authSection" class="max-w-md mx-auto p-4">
    <div class="card p-8">
      <div class="text-center mb-6">
        <div class="inline-grid place-items-center w-12 h-12 rounded-2xl bg-primary/80 font-black">E</div>
        <h1 class="text-2xl font-black text-accent mt-2">Giri≈ü</h1>
        <p class="text-xs opacity-75">PC / tablet / telefondan g√ºvenle kullan.</p>
      </div>
      <label class="block mb-2 text-sm opacity-80">E-posta</label>
      <input id="email" type="email" class="inp mb-4" placeholder="ornek@ehlizade.com" />
      <div class="mb-2 flex gap-2 items-end">
        <div class="flex-1">
          <label class="block mb-2 text-sm opacity-80">≈ûifre</label>
          <input id="password" type="password" class="inp" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <button id="togglePw" class="btn btn-sec" type="button">üëÅÔ∏è</button>
      </div>
      <div id="authMsg" class="text-xs mt-2 opacity-80"></div>
      <div class="mt-6 grid grid-cols-2 gap-2">
        <button id="loginBtn" class="btn">Giri≈ü</button>
        <button id="registerBtn" class="btn bg-accent text-black">Patron Kaydƒ±</button>
      </div>
      <div class="mt-4 text-xs opacity-70">
        <div><b>Not:</b> ƒ∞lk kullanƒ±cƒ± Patron olur; kasiyerleri panelden eklersin.</div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <main id="appSection" class="hidden max-w-6xl mx-auto p-4 pb-16">
    <!-- Tabs -->
    <div class="flex gap-2 mb-4">
      <button data-tab="today"   class="tab btn">Bug√ºn</button>
      <button data-tab="expense" class="tab btn">Gider</button>
      <button data-tab="history" class="tab btn">Ge√ßmi≈ü</button>
      <button data-tab="report"  class="tab btn">Rapor</button>
    </div>

    <!-- TODAY (INCOME) -->
    <section id="tab-today" class="space-y-4">
      <div class="card p-4">
        <h3 class="text-accent font-extrabold text-lg mb-3">Gelir Kaydƒ±</h3>
        <div class="grid md:grid-cols-5 gap-3">
          <div><label class="block mb-1 text-sm opacity-80">Tutar (‚Ç∫)</label><input id="incAmount" type="number" step="0.01" min="0" class="inp" placeholder="0,00" /></div>
          <div class="md:col-span-2"><label class="block mb-1 text-sm opacity-80">√ñdeme</label>
            <div class="flex gap-2">
              <button id="incCash" class="chip active" data-val="cash">NAKƒ∞T</button>
              <button id="incCard" class="chip"        data-val="card">KART</button>
            </div>
          </div>
          <div><label class="block mb-1 text-sm opacity-80">Personel</label><input id="incStaff" class="inp" placeholder="(opsiyonel)" /></div>
          <div><label class="block mb-1 text-sm opacity-80">Not</label><input id="incNote" class="inp" placeholder="(opsiyonel)" /></div>
        </div>
        <div class="mt-3"><button id="saveIncome" class="btn iconbtn">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>Kaydet</button></div>
      </div>

      <div class="card p-4">
        <div class="flex items-center gap-3 mb-3"><h4 class="font-bold">Bug√ºnk√º Gelirler</h4><div id="incTotals" class="ml-auto text-sm opacity-80">Nakit: ‚Ç∫0,00 | Kart: ‚Ç∫0,00 | Toplam: ‚Ç∫0,00</div></div>
        <div class="overflow-auto"><table class="tbl w-full text-sm"><thead><tr class="text-left">
          <th class="p-2">Saat</th><th class="p-2">Y√∂ntem</th><th class="p-2">Tutar</th><th class="p-2">Personel</th><th class="p-2">Not</th><th class="p-2 w-32">ƒ∞≈ülem</th>
        </tr></thead><tbody id="incBody"></tbody></table></div>
      </div>
    </section>

    <!-- EXPENSE -->
    <section id="tab-expense" class="hidden space-y-4">
      <div class="card p-4">
        <h3 class="text-accent font-extrabold text-lg mb-3">Gider Kaydƒ±</h3>
        <div class="grid md:grid-cols-5 gap-3">
          <div><label class="block mb-1 text-sm opacity-80">Tutar (‚Ç∫)</label><input id="expAmount" type="number" step="0.01" min="0" class="inp" placeholder="0,00" /></div>
          <div class="md:col-span-2"><label class="block mb-1 text-sm opacity-80">√ñdeme</label>
            <div class="flex gap-2">
              <button id="expCash" class="chip active" data-val="cash">NAKƒ∞T</button>
              <button id="expCard" class="chip"        data-val="card">KART</button>
            </div>
          </div>
          <div><label class="block mb-1 text-sm opacity-80">Personel</label><input id="expStaff" class="inp" placeholder="(opsiyonel)" /></div>
          <div><label class="block mb-1 text-sm opacity-80">Not</label><input id="expNote" class="inp" placeholder="(opsiyonel)" /></div>
        </div>
        <div class="mt-3"><button id="saveExpense" class="btn iconbtn">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>Kaydet</button></div>
      </div>

      <div class="card p-4">
        <div class="flex items-center gap-3 mb-3"><h4 class="font-bold">Bug√ºnk√º Giderler</h4><div id="expTotals" class="ml-auto text-sm opacity-80">Nakit: ‚Ç∫0,00 | Kart: ‚Ç∫0,00 | Toplam: ‚Ç∫0,00</div></div>
        <div class="overflow-auto"><table class="tbl w-full text-sm"><thead><tr class="text-left">
          <th class="p-2">Saat</th><th class="p-2">Y√∂ntem</th><th class="p-2">Tutar</th><th class="p-2">Personel</th><th class="p-2">Not</th><th class="p-2 w-32">ƒ∞≈ülem</th>
        </tr></thead><tbody id="expBody"></tbody></table></div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="tab-history" class="hidden space-y-4">
      <div class="card p-4">
        <div class="flex items-end gap-3">
          <div><label class="block mb-1 text-sm opacity-80">Tarih</label><input id="histDate" type="date" class="inp"/></div>
          <button id="loadHistory" class="btn">Y√ºkle</button>
          <div id="histTotals" class="ml-auto text-sm opacity-80">Gelir: ‚Ç∫0,00 | Gider: ‚Ç∫0,00 | Fark: ‚Ç∫0,00</div>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="card p-4"><h4 class="font-bold mb-2">Gelir</h4><div class="overflow-auto"><table class="tbl w-full text-sm">
          <thead><tr><th class="p-2">Saat</th><th class="p-2">Y√∂ntem</th><th class="p-2">Tutar</th><th class="p-2">Personel</th><th class="p-2">Not</th></tr></thead><tbody id="histInc"></tbody>
        </table></div></div>
        <div class="card p-4"><h4 class="font-bold mb-2">Gider</h4><div class="overflow-auto"><table class="tbl w-full text-sm">
          <thead><tr><th class="p-2">Saat</th><th class="p-2">Y√∂ntem</th><th class="p-2">Tutar</th><th class="p-2">Personel</th><th class="p-2">Not</th></tr></thead><tbody id="histExp"></tbody>
        </table></div></div>
      </div>
    </section>

    <!-- REPORT -->
    <section id="tab-report" class="hidden">
      <div class="card p-4">
        <h3 class="text-accent font-extrabold mb-3">G√ºn Sonu Raporu (Br√ºt)</h3>
        <div id="repLines" class="space-y-1 text-sm"></div>
        <button id="refreshReport" class="btn mt-3">Yenile</button>
      </div>
    </section>
  </main>

  <!-- ADMIN MODAL -->
  <div id="adminModal" class="modal">
    <div class="card w-[min(900px,98vw)] p-6">
      <div class="flex items-center mb-4">
        <h3 class="text-xl font-extrabold text-accent">Y√∂netim Paneli</h3>
        <button id="closeAdmin" class="ml-auto btn btn-sec">Kapat</button>
      </div>

      <div class="grid md:grid-cols-3 gap-4 mb-4">
        <div class="md:col-span-2">
          <h4 class="font-bold mb-2">Kullanƒ±cƒ±lar</h4>
          <div class="overflow-auto">
            <table class="tbl w-full text-sm">
              <thead><tr><th class="p-2">Email</th><th class="p-2">Rol</th><th class="p-2">Olu≈üturma</th><th class="p-2 w-40">ƒ∞≈ülem</th></tr></thead>
              <tbody id="userBody"></tbody>
            </table>
          </div>
        </div>
        <div>
          <h4 class="font-bold mb-2">Kasiyer Ekle</h4>
          <label class="block mb-1 text-sm opacity-80">E-posta</label>
          <input id="newEmail" class="inp mb-3" placeholder="kisi@ornek.com"/>
          <label class="block mb-1 text-sm opacity-80">≈ûifre</label>
          <input id="newPass" type="password" class="inp mb-3" placeholder="min 6"/>
          <button id="addCashier" class="btn w-full">Ekle</button>
          <p class="text-xs opacity-70 mt-2">Not: Ekleme sƒ±rasƒ±nda kƒ±sa s√ºreli oturum deƒüi≈üir; bittiƒüinde patron oturumun geri y√ºklenir.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ================= CONFIG (BURAYI DOLDUR) =================
    const SUPABASE_URL      = 'https://fhggiepjjsoirdggzfdq.supabase.co';           // Project Settings > API > Project URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZoZ2dpZXBqanNvaXJkZ2d6ZmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MjgxMTYsImV4cCI6MjA3MzUwNDExNn0.0fgefvOvU3T4ovn81Gnr57ywdQyDqR3QmplipuInapc';      // Project Settings > API > anon public key
    const TENANT_ID         = 'be61b393-b62f-4c9a-9686-f9f1c585c755';
    // ==========================================================
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Helpers
    const $ = (id)=>document.getElementById(id);
    const show = (id, on=true)=>$(id).classList.toggle('hidden', !on);
    const fmt = (n)=> new Intl.NumberFormat('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(n||0));
    const todayStr = ()=> new Date().toISOString().slice(0,10);
    const timeStr = (iso)=> new Date(iso).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
    function chipGroup(a,b){ a.classList.add('active'); a.onclick=()=>{a.classList.add('active');b.classList.remove('active')}; b.onclick=()=>{b.classList.add('active');a.classList.remove('active')};}
    function active(a,b){ return a.classList.contains('active') ? a.dataset.val : b.dataset.val; }
    function toast(msg, ok=true){ const t=$('toast'), b=$('toastBox'); b.textContent=msg; b.style.borderColor= ok? '#2e8b57':'#a33'; b.style.background= ok? '#163c20':'#441818'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }

    // State
    let profile = null; // { id, role, tenant_id, email? }

    // UI init
    chipGroup($('incCash'), $('incCard'));
    chipGroup($('expCash'), $('expCard'));
    $('histDate').value = todayStr();
    $('togglePw').onclick = ()=>{ const i=$('password'); i.type = i.type==='password'?'text':'password' };

    // Tabs
    document.querySelectorAll('.tab').forEach(t=> t.onclick = ()=> {
      document.querySelectorAll('[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
      $('tab-'+t.dataset.tab).classList.remove('hidden');
    });

    // AUTH
    $('loginBtn').onclick = async ()=>{
      const email = $('email').value.trim(); const password = $('password').value;
      if(!email || !password) return toast('E-posta ve ≈üifre zorunlu', false);
      const { error } = await supa.auth.signInWithPassword({ email, password });
      if(error) return toast('Giri≈ü hatasƒ±: '+error.message, false);
      await afterLogin();
    };

    $('registerBtn').onclick = async ()=>{
      const email = $('email').value.trim(); let password = $('password').value;
      if(!email) return toast('E-posta gir', false);
      if(!password) { password = prompt('Yeni patron ≈üifresi (min 6)'); if(!password) return; }
      const { error:e1 } = await supa.auth.signUp({ email, password });
      if(e1) return toast('Kayƒ±t hatasƒ±: '+e1.message, false);
      const { error:e2 } = await supa.auth.signInWithPassword({ email, password });
      if(e2) return toast('Oturum a√ßƒ±lamadƒ±: '+e2.message, false);
      const { error:e3 } = await supa.rpc('link_profile', { role_in:'owner', tenant_in: TENANT_ID, email_in: email });
      if(e3) return toast('Profil baƒülanamadƒ±: '+e3.message, false);
      toast('Patron olu≈üturuldu. ≈ûimdi giri≈ü yap.', true);
    };

    $('logoutBtn').onclick = async ()=>{ await supa.auth.signOut(); location.reload(); };

    async function afterLogin(){
      const { data:{ user } } = await supa.auth.getUser();
      const { data: prof, error } = await supa.from('profiles')
        .select('id, role, tenant_id, email, created_at').eq('id', user.id).single();
      if(error || !prof) return toast('Profil bulunamadƒ±. SQL fonksiyonunu kur.', false);
      profile = prof;

      show('authSection', false);
      show('appSection', true);
      show('logoutBtn', true);
      $('roleBadge').textContent = profile.role==='owner'?'Patron':'Kasiyer';
      show('roleBadge', true);
      show('adminBtn', profile.role==='owner'); // sadece patron g√∂r√ºr

      // ƒ∞lk ekran
      document.querySelector('[data-tab="today"]').click();
      await loadToday(); await loadExpenseToday(); await loadHistory(); await refreshReport();
    }

    // ADMIN PANEL
    $('adminBtn').onclick = async ()=>{ await refreshUsers(); $('adminModal').classList.add('show'); };
    $('closeAdmin').onclick = ()=> $('adminModal').classList.remove('show');

    async function refreshUsers(){
      // Patron kendi tenant'ƒ±ndaki t√ºm profilleri g√∂rebilir (policy ile)
      const { data, error } = await supa.from('profiles')
        .select('id, email, role, created_at')
        .eq('tenant_id', profile.tenant_id)
        .order('created_at',{ascending:true});

      if(error){ toast('Kullanƒ±cƒ± listesi alƒ±namadƒ±: '+error.message, false); return; }

      $('userBody').innerHTML = (data||[]).map(u=>{
        const self = u.id === profile.id;
        const roleLabel = u.role==='owner'?'Patron':'Kasiyer';
        return `<tr class="odd:bg-soft">
          <td class="p-2">${u.email||'(email yok)'}</td>
          <td class="p-2">${roleLabel}</td>
          <td class="p-2">${new Date(u.created_at).toLocaleString('tr-TR')}</td>
          <td class="p-2 flex gap-2">
            <button class="btn btn-sec text-xs" data-role="${u.id}" data-to="${u.role==='owner'?'cashier':'owner'}" ${self?'disabled':''}>
              Rol√º ${u.role==='owner'?'Kasiyer':'Patron'} yap
            </button>
            <button class="btn btn-sec text-xs" data-delprof="${u.id}" ${self?'disabled':''}>Profili Sil</button>
          </td>
        </tr>`;
      }).join('');

      // Role change
      document.querySelectorAll('[data-role]').forEach(b=>{
        b.onclick = async ()=>{
          const uid = b.getAttribute('data-role');
          const to  = b.getAttribute('data-to');
          if(!confirm('Rol deƒüi≈üsin mi?')) return;
          const { error } = await supa.rpc('set_role', { target_user: uid, new_role: to });
          if(error){ toast('Rol deƒüi≈ümedi: '+error.message, false); return; }
          toast('Rol g√ºncellendi'); await refreshUsers();
          // Eƒüer kendini d√º≈ü√ºrd√ºysen (disabled ile engelledik), oturumu yenilemek gerekir.
        };
      });

      // Delete profile (uyarƒ±: auth.users silinmez, sadece profiles satƒ±rƒ±)
      document.querySelectorAll('[data-delprof]').forEach(b=>{
        b.onclick = async ()=>{
          const uid = b.getAttribute('data-delprof');
          if(!confirm('Bu kullanƒ±cƒ±nƒ±n profilini silmek istediƒüine emin misin?')) return;
          const { error } = await supa.from('profiles').delete().eq('id', uid).eq('tenant_id', profile.tenant_id);
          if(error){ toast('Profil silinemedi: '+error.message, false); return; }
          toast('Profil silindi'); await refreshUsers();
        };
      });
    }

    // Add cashier without losing owner session (save/restore session)
    $('addCashier').onclick = async ()=>{
      const email = $('newEmail').value.trim();
      const password = $('newPass').value;
      if(!email || !password) return toast('Email ve ≈üifre zorunlu', false);

      // Save current owner session tokens
      const sess = await supa.auth.getSession();
      const prev = sess?.data?.session;
      if(!prev){ return toast('Oturum bulunamadƒ±', false); }

      // 1) signUp kasiyer
      const { error: e1 } = await supa.auth.signUp({ email, password });
      if(e1){ return toast('Kayƒ±t hatasƒ±: '+e1.message, false); }

      // 2) kasiyer oturumu yoksa login
      const { data:{ session: cs }, error: e2 } = await supa.auth.getSession();
      if(!cs || e2){ const { error: ee } = await supa.auth.signInWithPassword({ email, password });
        if(ee){ return toast('Kasiyer oturumu a√ßƒ±lamadƒ±: '+ee.message, false); }
      }

      // 3) profil baƒüla (cashier) ve email'i yaz
      const { error: e3 } = await supa.rpc('link_profile', { role_in:'cashier', tenant_in: TENANT_ID, email_in: email });
      if(e3){ return toast('Profil baƒülanamadƒ±: '+e3.message, false); }

      // 4) eski patron oturumunu geri y√ºkle
      const { error: e4 } = await supa.auth.setSession({ access_token: prev.access_token, refresh_token: prev.refresh_token });
      if(e4){ return toast('Patron oturumu geri y√ºklenemedi: '+e4.message, false); }

      $('newEmail').value=''; $('newPass').value='';
      toast('Kasiyer eklendi'); await refreshUsers();
    };

    // ===================== ENTRIES (CRUD) =====================
    function rowActions(id){ return `<button class="btn btn-sec text-xs" data-del="${id}" title="Sil">üóë Sil</button>`; }
    function bindDeleteHandlers(containerId, reloadFn){
      document.querySelectorAll('#'+containerId+' [data-del]').forEach(btn=>{
        btn.onclick = async ()=>{
          if(!confirm('Kayƒ±t silinsin mi?')) return;
          const id = btn.getAttribute('data-del');
          const { error } = await supa.from('entries').delete().eq('id', id).eq('tenant_id', profile.tenant_id);
          if(error){ toast('Silinemedi: '+error.message, false); return; }
          toast('Silindi'); await reloadFn();
        };
      });
    }

    async function loadToday(){
      const { data, error } = await supa.from('entries')
        .select('id, method, amount, staff, note, at_time')
        .eq('tenant_id', profile.tenant_id).eq('kind','income').eq('at_date', todayStr())
        .order('id',{ascending:false});
      if(error) return toast(error.message, false);
      const rows = data||[];
      $('incBody').innerHTML = rows.map(r=>`
        <tr class="odd:bg-soft">
          <td class="p-2">${timeStr(r.at_time)}</td>
          <td class="p-2">${r.method==='cash'?'Nakit':'Kart'}</td>
          <td class="p-2">‚Ç∫${fmt(r.amount)}</td>
          <td class="p-2">${r.staff||''}</td>
          <td class="p-2">${r.note||''}</td>
          <td class="p-2">${rowActions(r.id)}</td>
        </tr>`).join('');
      bindDeleteHandlers('incBody', loadToday);
      let c=0,k=0; rows.forEach(r=> r.method==='cash'? c+=Number(r.amount):k+=Number(r.amount));
      $('incTotals').textContent = `Nakit: ‚Ç∫${fmt(c)} | Kart: ‚Ç∫${fmt(k)} | Toplam: ‚Ç∫${fmt(c+k)}`;
    }

    $('saveIncome').onclick = async ()=>{
      const amount = Number($('incAmount').value);
      if(!amount || amount<=0) return toast('Ge√ßerli tutar gir', false);
      const method = active($('incCash'), $('incCard'));
      const staff = $('incStaff').value.trim() || null;
      const note  = $('incNote').value.trim() || null;
      const { error } = await supa.from('entries').insert({
        tenant_id: profile.tenant_id, kind:'income', method, amount, staff, note
      });
      if(error) return toast(error.message, false);
      $('incAmount').value=''; $('incNote').value=''; toast('Gelir eklendi'); await loadToday();
    };

    async function loadExpenseToday(){
      const { data, error } = await supa.from('entries')
        .select('id, method, amount, staff, note, at_time')
        .eq('tenant_id', profile.tenant_id).eq('kind','expense').eq('at_date', todayStr())
        .order('id',{ascending:false});
      if(error) return toast(error.message, false);
      const rows = data||[];
      $('expBody').innerHTML = rows.map(r=>`
        <tr class="odd:bg-soft">
          <td class="p-2">${timeStr(r.at_time)}</td>
          <td class="p-2">${r.method==='cash'?'Nakit':'Kart'}</td>
          <td class="p-2">‚Ç∫${fmt(r.amount)}</td>
          <td class="p-2">${r.staff||''}</td>
          <td class="p-2">${r.note||''}</td>
          <td class="p-2">${rowActions(r.id)}</td>
        </tr>`).join('');
      bindDeleteHandlers('expBody', loadExpenseToday);
      let c=0,k=0; rows.forEach(r=> r.method==='cash'? c+=Number(r.amount):k+=Number(r.amount));
      $('expTotals').textContent = `Nakit: ‚Ç∫${fmt(c)} | Kart: ‚Ç∫${fmt(k)} | Toplam: ‚Ç∫${fmt(c+k)}`;
    }

    $('saveExpense').onclick = async ()=>{
      const amount = Number($('expAmount').value);
      if(!amount || amount<=0) return toast('Ge√ßerli tutar gir', false);
      const method = active($('expCash'), $('expCard'));
      const staff = $('expStaff').value.trim() || null;
      const note  = $('expNote').value.trim() || null;
      const { error } = await supa.from('entries').insert({
        tenant_id: profile.tenant_id, kind:'expense', method, amount, staff, note
      });
      if(error) return toast(error.message, false);
      $('expAmount').value=''; $('expNote').value=''; toast('Gider eklendi'); await loadExpenseToday();
    };

    // HISTORY
    $('loadHistory').onclick = loadHistory;
    async function loadHistory(){
      const d = $('histDate').value || todayStr();
      const base = supa.from('entries').select('method, amount, staff, note, at_time')
        .eq('tenant_id', profile.tenant_id).eq('at_date', d);
      const [inc, exp] = await Promise.all([
        base.eq('kind','income').order('id',{ascending:false}),
        base.eq('kind','expense').order('id',{ascending:false}),
      ]);
      const incRows = inc.data||[], expRows = exp.data||[];
      $('histInc').innerHTML = incRows.map(r=>`
        <tr class="odd:bg-soft"><td class="p-2">${timeStr(r.at_time)}</td><td class="p-2">${r.method==='cash'?'Nakit':'Kart'}</td><td class="p-2">‚Ç∫${fmt(r.amount)}</td><td class="p-2">${r.staff||''}</td><td class="p-2">${r.note||''}</td></tr>`).join('');
      $('histExp').innerHTML = expRows.map(r=>`
        <tr class="odd:bg-soft"><td class="p-2">${timeStr(r.at_time)}</td><td class="p-2">${r.method==='cash'?'Nakit':'Kart'}</td><td class="p-2">‚Ç∫${fmt(r.amount)}</td><td class="p-2">${r.staff||''}</td><td class="p-2">${r.note||''}</td></tr>`).join('');
      const incSum = incRows.reduce((s,r)=>s+Number(r.amount),0);
      const expSum = expRows.reduce((s,r)=>s+Number(r.amount),0);
      $('histTotals').textContent = `Gelir: ‚Ç∫${fmt(incSum)} | Gider: ‚Ç∫${fmt(expSum)} | Fark: ‚Ç∫${fmt(incSum-expSum)}`;
    }

    // REPORT
    $('refreshReport').onclick = refreshReport;
    async function refreshReport(){
      const d = todayStr();
      const base = supa.from('entries').select('method, amount').eq('tenant_id', profile.tenant_id).eq('at_date', d);
      const [inc, exp] = await Promise.all([ base.eq('kind','income'), base.eq('kind','expense') ]);
      const incRows = inc.data||[], expRows = exp.data||[];
      let cash=0, card=0; incRows.forEach(r=> r.method==='cash'? cash+=Number(r.amount):card+=Number(r.amount));
      const expense = expRows.reduce((s,r)=> s+Number(r.amount), 0);
      $('repLines').innerHTML = [
        `Br√ºt Gelir: ‚Ç∫${fmt(cash+card)} (Nakit: ‚Ç∫${fmt(cash)} | Kart: ‚Ç∫${fmt(card)})`,
        `Toplam Gider: ‚Ç∫${fmt(expense)}`,
        `Kasa Farkƒ±: ‚Ç∫${fmt(cash+card-expense)}`
      ].map(l=>`<div>‚Ä¢ ${l}</div>`).join('');
    }

    // Boot: varsa oturumla devam
    (async ()=>{ const { data:{ session } } = await supa.auth.getSession(); if(session){ await afterLogin(); } })();
  </script>
</body>
</html>
